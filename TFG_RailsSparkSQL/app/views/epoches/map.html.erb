<% if @executed == 1 %>
  <p>
    <div id="mapa_madrid"></div>
  </p>
  <script>
      var mapa;

      var coords = <%= raw @speeds %>;

      var projections = {
          wgs84: "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs",
          ETRS89: "+proj=utm +zone=30 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
      };

      function initMap() {
          var centroMadrid = { lat:40.395734, lng:-3.6701306 };
          mapa = new google.maps.Map(document.getElementById('mapa_madrid'), {
              zoom: 10.75,
              center: centroMadrid
          });
          coords.forEach(function(each) {
              var reprojected = proj4(projections['ETRS89'], projections['wgs84'], [each[2], each[3]]);
              addMarker(reprojected[1], reprojected[0], each[0], each[1], each[4], each[5], each[6]);
          });
      }

      function addMarker(lat, lon, elementId, elementName, avgSpeed, epochStart, epochEnd) {
          var htmlDescription = "<p>Sensor: " + elementName + "</p>"+
                                "<p>Id: " + elementId + "</p>" +
                                "<p>Velocidad media: <strong>" + avgSpeed + "</strong></p>"+
                                "<p>En la Ã©poca de: <strong>" + epochStart + "</strong> y <strong>" + epochEnd + "</strong></p>";
          var infoWindow = new google.maps.InfoWindow({
              content: htmlDescription
          });
          var marker = new google.maps.Marker({
              position: { lat: lat, lng: lon },
              map: mapa,
              title: "Sensor: " + elementName
          });
          marker.addListener('click', function() {
              infoWindow.open(mapa, marker);
          });
      }

      google.maps.event.addDomListener(window, 'load', initMap);
  </script>
<% end %>
<pre><%= @execution %></pre>